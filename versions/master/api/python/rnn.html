<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>RNN Cell API — mxnet  documentation</title>
<link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" rel="stylesheet">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
<link href="../../_static/basic.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/mxnet.css" rel="stylesheet" type="text/css">
<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
<script src="../../_static/jquery-1.11.1.js" type="text/javascript"></script>
<script src="../../_static/underscore.js" type="text/javascript"></script>
<script src="../../_static/searchtools_custom.js" type="text/javascript"></script>
<script src="../../_static/doctools.js" type="text/javascript"></script>
<script src="../../_static/selectlang.js" type="text/javascript"></script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
<script type="text/javascript"> jQuery(function() { Search.loadIndex("/searchindex.js"); Search.init();}); </script>
<script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new
      Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-96378503-1', 'auto');
      ga('send', 'pageview');

    </script>
<!-- -->
<!-- <script type="text/javascript" src="../../_static/jquery.js"></script> -->
<!-- -->
<!-- <script type="text/javascript" src="../../_static/underscore.js"></script> -->
<!-- -->
<!-- <script type="text/javascript" src="../../_static/doctools.js"></script> -->
<!-- -->
<!-- <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
<!-- -->
<link href="../../genindex.html" rel="index" title="Index"/>
<link href="../../search.html" rel="search" title="Search"/>
<link href="index.html" rel="up" title="MXNet - Python API"/>
<link href="kvstore.html" rel="next" title="KVStore API"/>
<link href="gluon.html" rel="prev" title="Gluon Package"/>
<link href="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/image/mxnet-icon.png" rel="icon" type="image/png">
</link></link></link></link></meta></meta></meta></head>
<body role="document"><!-- Previous Navbar Layout
<div class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="../../" class="navbar-brand">
        <img src="http://data.mxnet.io/theme/mxnet.png">
      </a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul id="navbar" class="navbar navbar-left">
        
        <li> <a href="../../get_started/index.html">Get Started</a> </li>
        
        <li> <a href="../../tutorials/index.html">Tutorials</a> </li>
        
        <li> <a href="../../how_to/index.html">How To</a> </li>
        
        
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="true">Packages <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../../packages/python/index.html">
                Python
            </a></li>
            
            <li><a href="../../packages/r/index.html">
                R
            </a></li>
            
            <li><a href="../../packages/julia/index.html">
                Julia
            </a></li>
            
            <li><a href="../../packages/c++/index.html">
                C++
            </a></li>
            
            <li><a href="../../packages/scala/index.html">
                Scala
            </a></li>
            
            <li><a href="../../packages/perl/index.html">
                Perl
            </a></li>
            
          </ul>
        </li>
        
        <li> <a href="../../system/index.html">System</a> </li>
        <li> 
<form class="" role="search" action="../../search.html" method="get" autocomplete="off">
  <div class="form-group inner-addon left-addon">
    <i class="glyphicon glyphicon-search"></i>
    <input type="text" name="q" class="form-control" placeholder="Search">
  </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
  
</form> </li>
      </ul>
      <ul id="navbar" class="navbar navbar-right">
        <li> <a href="../../index.html"><span class="flag-icon flag-icon-us"></span></a> </li>
        <li> <a href="../..//zh/index.html"><span class="flag-icon flag-icon-cn"></span></a> </li>
      </ul>
    </div>
  </div>
</div>
Previous Navbar Layout End -->
<div class="navbar navbar-fixed-top">
<div class="container" id="navContainer">
<div class="innder" id="header-inner">
<h1 id="logo-wrap">
<a href="../../" id="logo"><img src="http://data.mxnet.io/theme/mxnet.png"/></a>
</h1>
<nav class="nav-bar" id="main-nav">
<a class="main-nav-link" href="../../get_started/install.html">Install</a>
<a class="main-nav-link" href="../../tutorials/index.html">Tutorials</a>
<a class="main-nav-link" href="../../how_to/index.html">How To</a>
<span id="dropdown-menu-position-anchor">
<a aria-expanded="true" aria-haspopup="true" class="main-nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button">API <span class="caret"></span></a>
<ul class="dropdown-menu" id="package-dropdown-menu">
<li><a class="main-nav-link" href="../../api/python/index.html">Python</a></li>
<li><a class="main-nav-link" href="../../api/scala/index.html">Scala</a></li>
<li><a class="main-nav-link" href="../../api/r/index.html">R</a></li>
<li><a class="main-nav-link" href="../../api/julia/index.html">Julia</a></li>
<li><a class="main-nav-link" href="../../api/c++/index.html">C++</a></li>
<li><a class="main-nav-link" href="../../api/perl/index.html">Perl</a></li>
</ul>
</span>
<a class="main-nav-link" href="../../architecture/index.html">Architecture</a>
<!-- <a class="main-nav-link" href="../../community/index.html">Community</a> -->
<a class="main-nav-link" href="https://github.com/dmlc/mxnet">Github</a>
<span id="dropdown-menu-position-anchor-version" style="position: relative"><a href="#" class="main-nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="true">Versions(master)<span class="caret"></span></a><ul id="package-dropdown-menu" class="dropdown-menu"><li><a class="main-nav-link" href=http://localhost:8008/>v0.10.0</a></li><li><a class="main-nav-link" href=http://localhost:8008/versions/v0.10.0-rc0/index.html>v0.10.0-rc0</a></li><li><a class="main-nav-link" href=http://localhost:8008/versions/master/index.html>master</a></li></ul></span></nav>
<script> function getRootPath(){ return "../../" } </script>
<div class="burgerIcon dropdown">
<a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">☰</a>
<ul class="dropdown-menu" id="burgerMenu">
<li><a href="../../get_started/install.html">Install</a></li>
<li><a href="../../tutorials/index.html">Tutorials</a></li>
<li><a href="../../how_to/index.html">How To</a></li>
<li class="dropdown-submenu">
<a href="#" tabindex="-1">API</a>
<ul class="dropdown-menu">
<li><a href="../../api/python/index.html" tabindex="-1">Python</a>
</li>
<li><a href="../../api/scala/index.html" tabindex="-1">Scala</a>
</li>
<li><a href="../../api/r/index.html" tabindex="-1">R</a>
</li>
<li><a href="../../api/julia/index.html" tabindex="-1">Julia</a>
</li>
<li><a href="../../api/c++/index.html" tabindex="-1">C++</a>
</li>
<li><a href="../../api/perl/index.html" tabindex="-1">Perl</a>
</li>
</ul>
</li>
<li><a href="../../architecture/index.html">Architecture</a></li>
<li><a class="main-nav-link" href="https://github.com/dmlc/mxnet">Github</a></li>
<li id="dropdown-menu-position-anchor-version-mobile" class="dropdown-submenu" style="position: relative"><a href="#" tabindex="-1">Versions(master)</a><ul class="dropdown-menu"><li><a tabindex="-1" href=http://localhost:8008/>v0.10.0</a></li><li><a tabindex="-1" href=http://localhost:8008/versions/v0.10.0-rc0/index.html>v0.10.0-rc0</a></li><li><a tabindex="-1" href=http://localhost:8008/versions/master/index.html>master</a></li></ul><li></ul>
</div>
<div class="plusIcon dropdown">
<a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button"><span aria-hidden="true" class="glyphicon glyphicon-plus"></span></a>
<ul class="dropdown-menu" id="plusMenu"></ul>
</div>
<div id="search-input-wrap">
<form action="../../search.html" autocomplete="off" class="" method="get" role="search">
<div class="form-group inner-addon left-addon">
<i class="glyphicon glyphicon-search"></i>
<input class="form-control" name="q" placeholder="Search" type="text">
</input></div>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
<div id="search-preview"></div>
</div>
<div id="searchIcon">
<span aria-hidden="true" class="glyphicon glyphicon-search"></span>
</div>
<!-- <div id="lang-select-wrap"> -->
<!--   <label id="lang-select-label"> -->
<!--     <\!-- <i class="fa fa-globe"></i> -\-> -->
<!--     <span></span> -->
<!--   </label> -->
<!--   <select id="lang-select"> -->
<!--     <option value="en">Eng</option> -->
<!--     <option value="zh">中文</option> -->
<!--   </select> -->
<!-- </div> -->
<!--     <a id="mobile-nav-toggle">
        <span class="mobile-nav-toggle-bar"></span>
        <span class="mobile-nav-toggle-bar"></span>
        <span class="mobile-nav-toggle-bar"></span>
      </a> -->
</div>
</div>
</div>
<div class="container">
<div class="row">
<div aria-label="main navigation" class="sphinxsidebar leftsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Python Documents</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#table-of-contents">Table of contents</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="ndarray.html">NDArray API</a></li>
<li class="toctree-l3"><a class="reference internal" href="symbol.html">Symbol API</a></li>
<li class="toctree-l3"><a class="reference internal" href="module.html">Module API</a></li>
<li class="toctree-l3"><a class="reference internal" href="gluon.html">Gluon Package</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">RNN Cell API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-rnn-module">The <code class="docutils literal"><span class="pre">rnn</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#api-reference">API Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="kvstore.html">KVStore API</a></li>
<li class="toctree-l3"><a class="reference internal" href="io.html">Data Loading API</a></li>
<li class="toctree-l3"><a class="reference internal" href="image.html">Image API</a></li>
<li class="toctree-l3"><a class="reference internal" href="optimization.html">Optimization: initialize and update weights</a></li>
<li class="toctree-l3"><a class="reference internal" href="callback.html">Callback API</a></li>
<li class="toctree-l3"><a class="reference internal" href="metric.html">Evaluation Metric API</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../r/index.html">R Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../julia/index.html">Julia Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../c++/index.html">C++ Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scala/index.html">Scala Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../perl/index.html">Perl Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to/index.html">HowTo Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/index.html">System Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
</ul>
</div>
</div>
<div class="content">
<div class="section" id="rnn-cell-api">
<span id="rnn-cell-api"></span><h1>RNN Cell API<a class="headerlink" href="#rnn-cell-api" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This package is currently experimental and may change in the near future.</p>
</div>
<div class="section" id="overview">
<span id="overview"></span><h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">rnn</span></code> module includes the recurrent neural network (RNN) cell APIs, a suite of tools for building an RNN’s symbolic graph.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <cite>rnn</cite> module offers higher-level interface while <cite>symbol.RNN</cite> is a lower-level interface. The cell APIs in <cite>rnn</cite> module are easier to use in most cases.</p>
</div>
</div>
<div class="section" id="the-rnn-module">
<span id="the-rnn-module"></span><h2>The <code class="docutils literal"><span class="pre">rnn</span></code> module<a class="headerlink" href="#the-rnn-module" title="Permalink to this headline">¶</a></h2>
<div class="section" id="cell-interfaces">
<span id="cell-interfaces"></span><h3>Cell interfaces<a class="headerlink" href="#cell-interfaces" title="Permalink to this headline">¶</a></h3>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%"></col>
<col width="90%"></col>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">BaseRNNCell.__call__</span></code></td>
<td></td>
</tr>
<tr class="row-even"><td><code class="xref py py-obj docutils literal"><span class="pre">BaseRNNCell.unroll</span></code></td>
<td></td>
</tr>
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">BaseRNNCell.reset</span></code></td>
<td></td>
</tr>
<tr class="row-even"><td><code class="xref py py-obj docutils literal"><span class="pre">BaseRNNCell.begin_state</span></code></td>
<td></td>
</tr>
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">BaseRNNCell.unpack_weights</span></code></td>
<td></td>
</tr>
<tr class="row-even"><td><code class="xref py py-obj docutils literal"><span class="pre">BaseRNNCell.pack_weights</span></code></td>
<td></td>
</tr>
</tbody>
</table>
<p>When working with the cell API, the precise input and output symbols
depend on the type of RNN you are using. Take Long Short-Term Memory (LSTM) for example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mxnet</span> <span class="kn">as</span> <span class="nn">mx</span>
<span class="c1"># Shape of 'step_data' is (batch_size,).</span>
<span class="n">step_input</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="s1">'step_data'</span><span class="p">)</span>

<span class="c1"># First we embed our raw input data to be used as LSTM's input.</span>
<span class="n">embedded_step</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">step_input</span><span class="p">,</span> \
                                    <span class="n">input_dim</span><span class="o">=</span><span class="n">input_dim</span><span class="p">,</span> \
                                    <span class="n">output_dim</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">)</span>

<span class="c1"># Then we create an LSTM cell.</span>
<span class="n">lstm_cell</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">LSTMCell</span><span class="p">(</span><span class="n">num_hidden</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="c1"># Initialize its hidden and memory states.</span>
<span class="c1"># 'begin_state' method takes an initialization function, and uses 'zeros' by default.</span>
<span class="n">begin_state</span> <span class="o">=</span> <span class="n">lstm_cell</span><span class="o">.</span><span class="n">begin_state</span><span class="p">()</span>
</pre></div>
</div>
<p>The LSTM cell and other non-fused RNN cells are callable. Calling the cell updates it’s state once. This transformation depends on both the current input and the previous states. See this <a class="reference external" href="http://colah.github.io/posts/2015-08-Understanding-LSTMs/">blog post</a> for a great introduction to LSTM and other RNN.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Call the cell to get the output of one time step for a batch.</span>
<span class="n">output</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">lstm_cell</span><span class="p">(</span><span class="n">embedded_step</span><span class="p">,</span> <span class="n">begin_state</span><span class="p">)</span>

<span class="c1"># 'output' is lstm_t0_out_output of shape (batch_size, hidden_dim).</span>

<span class="c1"># 'states' has the recurrent states that will be carried over to the next step,</span>
<span class="c1"># which includes both the "hidden state" and the "cell state":</span>
<span class="c1"># Both 'lstm_t0_out_output' and 'lstm_t0_state_output' have shape (batch_size, hidden_dim).</span>
</pre></div>
</div>
<p>Most of the time our goal is to process a sequence of many steps. For this, we need to unroll the LSTM according to the sequence length.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Embed a sequence. 'seq_data' has the shape of (batch_size, sequence_length).</span>
<span class="n">seq_input</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="s1">'seq_data'</span><span class="p">)</span>
<span class="n">embedded_seq</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">seq_input</span><span class="p">,</span> \
                                   <span class="n">input_dim</span><span class="o">=</span><span class="n">input_dim</span><span class="p">,</span> \
                                   <span class="n">output_dim</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Remember to reset the cell when unrolling/stepping for a new sequence by calling <cite>lstm_cell.reset()</cite>.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Note that when unrolling, if 'merge_outputs' is set to True, the 'outputs' is merged into a single symbol</span>
<span class="c1"># In the layout, 'N' represents batch size, 'T' represents sequence length, and 'C' represents the</span>
<span class="c1"># number of dimensions in hidden states.</span>
<span class="n">outputs</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">lstm_cell</span><span class="o">.</span><span class="n">unroll</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span> \
                                   <span class="n">inputs</span><span class="o">=</span><span class="n">embedded_seq</span><span class="p">,</span> \
                                   <span class="n">layout</span><span class="o">=</span><span class="s1">'NTC'</span><span class="p">,</span> \
                                   <span class="n">merge_outputs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># 'outputs' is concat0_output of shape (batch_size, sequence_length, hidden_dim).</span>
<span class="c1"># The hidden state and cell state from the final time step is returned:</span>
<span class="c1"># Both 'lstm_t4_out_output' and 'lstm_t4_state_output' have shape (batch_size, hidden_dim).</span>

<span class="c1"># If merge_outputs is set to False, a list of symbols for each of the time steps is returned.</span>
<span class="n">outputs</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">lstm_cell</span><span class="o">.</span><span class="n">unroll</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span> \
                                   <span class="n">inputs</span><span class="o">=</span><span class="n">embedded_seq</span><span class="p">,</span> \
                                   <span class="n">layout</span><span class="o">=</span><span class="s1">'NTC'</span><span class="p">,</span> \
                                   <span class="n">merge_outputs</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c1"># In this case, 'outputs' is a list of symbols. Each symbol is of shape (batch_size, hidden_dim).</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Loading and saving models that are built with RNN cells API requires using
<cite>mx.rnn.load_rnn_checkpoint</cite>, <cite>mx.rnn.save_rnn_checkpoint</cite>, and <cite>mx.rnn.do_rnn_checkpoint</cite>.
The list of all the used cells should be provided as the first argument to those functions.</p>
</div>
</div>
<div class="section" id="basic-rnn-cells">
<span id="basic-rnn-cells"></span><h3>Basic RNN cells<a class="headerlink" href="#basic-rnn-cells" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">rnn</span></code> module supports the following RNN cell types.</p>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%"></col>
<col width="90%"></col>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">LSTMCell</span></code></td>
<td></td>
</tr>
<tr class="row-even"><td><code class="xref py py-obj docutils literal"><span class="pre">GRUCell</span></code></td>
<td></td>
</tr>
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">RNNCell</span></code></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="modifier-cells">
<span id="modifier-cells"></span><h3>Modifier cells<a class="headerlink" href="#modifier-cells" title="Permalink to this headline">¶</a></h3>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%"></col>
<col width="90%"></col>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">BidirectionalCell</span></code></td>
<td></td>
</tr>
<tr class="row-even"><td><code class="xref py py-obj docutils literal"><span class="pre">DropoutCell</span></code></td>
<td></td>
</tr>
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">ZoneoutCell</span></code></td>
<td></td>
</tr>
<tr class="row-even"><td><code class="xref py py-obj docutils literal"><span class="pre">ResidualCell</span></code></td>
<td></td>
</tr>
</tbody>
</table>
<p>A modifier cell takes in one or more cells and transforms the output of those cells.
<code class="docutils literal"><span class="pre">BidirectionalCell</span></code> is one example. It takes two cells for forward unroll and backward unroll
respectively. After unrolling, the outputs of the forward and backward pass are concatenated.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Bidirectional cell takes two RNN cells, for forward and backward pass respectively.</span>
<span class="c1"># Having different types of cells for forward and backward unrolling is allowed.</span>
<span class="n">bi_cell</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">BidirectionalCell</span><span class="p">(</span>
                 <span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">LSTMCell</span><span class="p">(</span><span class="n">num_hidden</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span>
                 <span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">GRUCell</span><span class="p">(</span><span class="n">num_hidden</span><span class="o">=</span><span class="mi">75</span><span class="p">))</span>
<span class="n">outputs</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">bi_cell</span><span class="o">.</span><span class="n">unroll</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span> \
                                 <span class="n">inputs</span><span class="o">=</span><span class="n">embedded_seq</span><span class="p">,</span> \
                                 <span class="n">merge_outputs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># The output feature is the concatenation of the forward and backward pass.</span>
<span class="c1"># Thus, the number of output dimensions is the sum of the dimensions of the two cells.</span>
<span class="c1"># 'outputs' is the symbol 'bi_out_output' of shape (batch_size, sequence_length, 125L)</span>

<span class="c1"># The states of the BidirectionalCell is a list of two lists, corresponding to the</span>
<span class="c1"># states of the forward and backward cells respectively.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">BidirectionalCell cannot be called or stepped, because the backward unroll requires the output of
future steps, and thus the whole sequence is required.</p>
</div>
<p>Dropout and zoneout are popular regularization techniques that can be applied to RNN. <code class="docutils literal"><span class="pre">rnn</span></code>
module provides <code class="docutils literal"><span class="pre">DropoutCell</span></code> and <code class="docutils literal"><span class="pre">ZoneoutCell</span></code> for regularization on the output and recurrent
states of RNN. <code class="docutils literal"><span class="pre">ZoneoutCell</span></code> takes one RNN cell in the constructor, and supports unrolling like
other cells.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">zoneout_cell</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">ZoneoutCell</span><span class="p">(</span><span class="n">lstm_cell</span><span class="p">,</span> <span class="n">zoneout_states</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">outputs</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">zoneout_cell</span><span class="o">.</span><span class="n">unroll</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span> \
                                      <span class="n">inputs</span><span class="o">=</span><span class="n">embedded_seq</span><span class="p">,</span> \
                                      <span class="n">merge_outputs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">DropoutCell</span></code> performs dropout on the input sequence. It can be used in a stacked
multi-layer RNN setting, which we will cover next.</p>
<p>Residual connection is a useful technique for training deep neural models because it helps the
propagation of gradients by shortening the paths.  <code class="docutils literal"><span class="pre">ResidualCell</span></code> provides such functionality for
RNN models.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">residual_cell</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">ResidualCell</span><span class="p">(</span><span class="n">lstm_cell</span><span class="p">)</span>
<span class="n">outputs</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">residual_cell</span><span class="o">.</span><span class="n">unroll</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span> \
                                       <span class="n">inputs</span><span class="o">=</span><span class="n">embedded_seq</span><span class="p">,</span> \
                                       <span class="n">merge_outputs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">outputs</span></code> are the element-wise sum of both the input and the output of the LSTM cell.</p>
</div>
<div class="section" id="multi-layer-cells">
<span id="multi-layer-cells"></span><h3>Multi-layer cells<a class="headerlink" href="#multi-layer-cells" title="Permalink to this headline">¶</a></h3>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%"></col>
<col width="90%"></col>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">SequentialRNNCell</span></code></td>
<td></td>
</tr>
<tr class="row-even"><td><code class="xref py py-obj docutils literal"><span class="pre">SequentialRNNCell.add</span></code></td>
<td></td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal"><span class="pre">SequentialRNNCell</span></code> allows stacking multiple layers of RNN cells to improve the expressiveness
and performance of the model. Cells can be added to a <code class="docutils literal"><span class="pre">SequentialRNNCell</span></code> in order, from bottom to
top. When unrolling, the output of a lower-level cell is automatically passed to the cell above.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">stacked_rnn_cells</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">SequentialRNNCell</span><span class="p">()</span>
<span class="n">stacked_rnn_cells</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">BidirectionalCell</span><span class="p">(</span>
                          <span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">LSTMCell</span><span class="p">(</span><span class="n">num_hidden</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span>
                          <span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">LSTMCell</span><span class="p">(</span><span class="n">num_hidden</span><span class="o">=</span><span class="mi">50</span><span class="p">)))</span>

<span class="c1"># Dropout the output of the bottom layer BidirectionalCell with a retention probability of 0.5.</span>
<span class="n">stacked_rnn_cells</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">DropoutCell</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>

<span class="n">stacked_rnn_cells</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">LSTMCell</span><span class="p">(</span><span class="n">num_hidden</span><span class="o">=</span><span class="mi">50</span><span class="p">))</span>
<span class="n">outputs</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">stacked_rnn_cells</span><span class="o">.</span><span class="n">unroll</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span> \
                                           <span class="n">inputs</span><span class="o">=</span><span class="n">embedded_seq</span><span class="p">,</span> \
                                           <span class="n">merge_outputs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># The output of SequentialRNNCell is the same as that of the last layer.</span>
<span class="c1"># In this case 'outputs' is the symbol 'concat6_output' of shape (batch_size, sequence_length, hidden_dim)</span>
<span class="c1"># The states of the SequentialRNNCell is a list of lists, with each list</span>
<span class="c1"># corresponding to the states of each of the added cells respectively.</span>
</pre></div>
</div>
</div>
<div class="section" id="fused-rnn-cell">
<span id="fused-rnn-cell"></span><h3>Fused RNN cell<a class="headerlink" href="#fused-rnn-cell" title="Permalink to this headline">¶</a></h3>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%"></col>
<col width="90%"></col>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">FusedRNNCell</span></code></td>
<td></td>
</tr>
<tr class="row-even"><td><code class="xref py py-obj docutils literal"><span class="pre">FusedRNNCell.unfuse</span></code></td>
<td></td>
</tr>
</tbody>
</table>
<p>The computation of an RNN for an input sequence consists of many GEMM and point-wise operations with
temporal dependencies dependencies. This could make the computation memory-bound especially on GPU,
resulting in longer wall-time. By combining the computation of many small matrices into that of
larger ones and streaming the computation whenever possible, the ratio of computation to memory I/O
can be increased, which results in better performance on GPU. Such optimization technique is called
“fusing”.
<a class="reference external" href="https://devblogs.nvidia.com/parallelforall/optimizing-recurrent-neural-networks-cudnn-5/">This post</a>
talks in greater detail.</p>
<p>The <code class="docutils literal"><span class="pre">rnn</span></code> module includes a <code class="docutils literal"><span class="pre">FusedRNNCell</span></code>, which provides the optimized fused implementation.
The FusedRNNCell supports bidirectional RNNs and dropout.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">fused_lstm_cell</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">FusedRNNCell</span><span class="p">(</span><span class="n">num_hidden</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> \
                                      <span class="n">num_layers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> \
                                      <span class="n">mode</span><span class="o">=</span><span class="s1">'lstm'</span><span class="p">,</span> \
                                      <span class="n">bidirectional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> \
                                      <span class="n">dropout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">outputs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fused_lstm_cell</span><span class="o">.</span><span class="n">unroll</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span> \
                                    <span class="n">inputs</span><span class="o">=</span><span class="n">embedded_seq</span><span class="p">,</span> \
                                    <span class="n">merge_outputs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># The 'outputs' is the symbol 'lstm_rnn_output' that has the shape</span>
<span class="c1"># (batch_size, sequence_length, forward_backward_concat_dim)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><cite>FusedRNNCell</cite> supports GPU-only. It cannot be called or stepped.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When <cite>dropout</cite> is set to non-zero in <cite>FusedRNNCell</cite>, the dropout is applied to the
output of all layers except the last layer. If there is only one layer in the <cite>FusedRNNCell</cite>, the
dropout rate is ignored.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Similar to <cite>BidirectionalCell</cite>, when <cite>bidirectional</cite> flag is set to <cite>True</cite>, the output
of <cite>FusedRNNCell</cite> is twice the size specified by <cite>num_hidden</cite>.</p>
</div>
<p>When training a deep, complex model <em>on multiple GPUs</em> it’s recommended to stack
fused RNN cells (one layer per cell) together instead of one with all layers.
The reason is that fused RNN cells don’t set gradients to be ready until the
computation for the entire layer is completed. Breaking a multi-layer fused RNN
cell into several one-layer ones allows gradients to be processed ealier. This
reduces communication overhead, especially with multiple GPUs.</p>
<p>The <code class="docutils literal"><span class="pre">unfuse()</span></code> method can be used to convert the <code class="docutils literal"><span class="pre">FusedRNNCell</span></code> into an equivalent
and CPU-compatible <code class="docutils literal"><span class="pre">SequentialRNNCell</span></code> that mirrors the settings of the <code class="docutils literal"><span class="pre">FusedRNNCell</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">unfused_lstm_cell</span> <span class="o">=</span> <span class="n">fused_lstm_cell</span><span class="o">.</span><span class="n">unfuse</span><span class="p">()</span>
<span class="n">unfused_outputs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">unfused_lstm_cell</span><span class="o">.</span><span class="n">unroll</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span> \
                                              <span class="n">inputs</span><span class="o">=</span><span class="n">embedded_seq</span><span class="p">,</span> \
                                              <span class="n">merge_outputs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># The 'outputs' is the symbol 'lstm_bi_l2_out_output' that has the shape</span>
<span class="c1"># (batch_size, sequence_length, forward_backward_concat_dim)</span>
</pre></div>
</div>
</div>
<div class="section" id="rnn-checkpoint-methods-and-parameters">
<span id="rnn-checkpoint-methods-and-parameters"></span><h3>RNN checkpoint methods and parameters<a class="headerlink" href="#rnn-checkpoint-methods-and-parameters" title="Permalink to this headline">¶</a></h3>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%"></col>
<col width="90%"></col>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">save_rnn_checkpoint</span></code></td>
<td></td>
</tr>
<tr class="row-even"><td><code class="xref py py-obj docutils literal"><span class="pre">load_rnn_checkpoint</span></code></td>
<td></td>
</tr>
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">do_rnn_checkpoint</span></code></td>
<td></td>
</tr>
</tbody>
</table>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%"></col>
<col width="90%"></col>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">RNNParams</span></code></td>
<td></td>
</tr>
<tr class="row-even"><td><code class="xref py py-obj docutils literal"><span class="pre">RNNParams.get</span></code></td>
<td></td>
</tr>
</tbody>
</table>
<p>The model parameters from the training with fused cell can be used for inference with unfused cell,
and vice versa. As the parameters of fused and unfused cells are organized differently, they need to
be converted first. <code class="docutils literal"><span class="pre">FusedRNNCell</span></code>‘s parameters are merged and flattened. In the fused example above,
the mode has <code class="docutils literal"><span class="pre">lstm_parameters</span></code> of shape <code class="docutils literal"><span class="pre">(total_num_params,)</span></code>, whereas the
equivalent SequentialRNNCell’s parameters are separate:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="s1">'lstm_l0_i2h_weight'</span><span class="p">:</span> <span class="p">(</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
<span class="s1">'lstm_l0_i2h_bias'</span><span class="p">:</span> <span class="p">(</span><span class="n">out_dim</span><span class="p">,)</span>
<span class="s1">'lstm_l0_h2h_weight'</span><span class="p">:</span> <span class="p">(</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
<span class="s1">'lstm_l0_h2h_bias'</span><span class="p">:</span> <span class="p">(</span><span class="n">out_dim</span><span class="p">,)</span>
<span class="s1">'lstm_r0_i2h_weight'</span><span class="p">:</span> <span class="p">(</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>All cells in the <code class="docutils literal"><span class="pre">rnn</span></code> module support the method <code class="docutils literal"><span class="pre">unpack_weights()</span></code> for converting <code class="docutils literal"><span class="pre">FusedRNNCell</span></code>
parameters to the unfused format and <code class="docutils literal"><span class="pre">pack_weights()</span></code> for fusing the parameters. The RNN-specific
checkpointing methods (<code class="docutils literal"><span class="pre">load_rnn_checkpoint,</span> <span class="pre">save_rnn_checkpoint,</span> <span class="pre">do_rnn_checkpoint</span></code>) handle the
conversion transparently based on the provided cells.</p>
</div>
<div class="section" id="i-o-utilities">
<span id="i-o-utilities"></span><h3>I/O utilities<a class="headerlink" href="#i-o-utilities" title="Permalink to this headline">¶</a></h3>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%"></col>
<col width="90%"></col>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">BucketSentenceIter</span></code></td>
<td></td>
</tr>
<tr class="row-even"><td><code class="xref py py-obj docutils literal"><span class="pre">encode_sentences</span></code></td>
<td></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="api-reference">
<span id="api-reference"></span><h2>API Reference<a class="headerlink" href="#api-reference" title="Permalink to this headline">¶</a></h2>
<script src="../../_static/js/auto_module_index.js" type="text/javascript"></script><script>auto_index("api-reference");</script></div>
</div>
<div class="container">
<div class="footer">
<p> © 2015-2017 DMLC. All rights reserved. </p>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar rightsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li><a class="reference internal" href="#">RNN Cell API</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#the-rnn-module">The <code class="docutils literal"><span class="pre">rnn</span></code> module</a><ul>
<li><a class="reference internal" href="#cell-interfaces">Cell interfaces</a></li>
<li><a class="reference internal" href="#basic-rnn-cells">Basic RNN cells</a></li>
<li><a class="reference internal" href="#modifier-cells">Modifier cells</a></li>
<li><a class="reference internal" href="#multi-layer-cells">Multi-layer cells</a></li>
<li><a class="reference internal" href="#fused-rnn-cell">Fused RNN cell</a></li>
<li><a class="reference internal" href="#rnn-checkpoint-methods-and-parameters">RNN checkpoint methods and parameters</a></li>
<li><a class="reference internal" href="#i-o-utilities">I/O utilities</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api-reference">API Reference</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div> <!-- pagename != index -->
<script crossorigin="anonymous" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="../../_static/js/sidebar.js" type="text/javascript"></script>
<script src="../../_static/js/search.js" type="text/javascript"></script>
<script src="../../_static/js/navbar.js" type="text/javascript"></script>
<script src="../../_static/js/clipboard.min.js" type="text/javascript"></script>
<script src="../../_static/js/copycode.js" type="text/javascript"></script>
<script type="text/javascript">
        $('body').ready(function () {
            $('body').css('visibility', 'visible');
        });
    </script>
</div></body>
</html>